-- ModuleScript: ApexUI

local ApexUI = {}

-- [[ الإعدادات والثوابت الفخمة ]] --
ApexUI.Colors = {
    Primary = Color3.fromRGB(0, 255, 200),  -- فيروزي متوهج (Glow)
    Secondary = Color3.fromRGB(15, 15, 25), -- خلفية داكنة جداً
    BackgroundShadow = Color3.fromRGB(20, 20, 30), -- ظل/خلفية ثانوية
    Accent = Color3.fromRGB(255, 50, 150),  -- أرجواني نابض بالحياة
    Text = Color3.new(0.95, 0.95, 0.95)
}

-- [[ خدمات روبلوكس ]] --
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- [[ الدوال المساعدة البصرية ]] --

local function createCorner(radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius)
    return corner
end

local function createStroke(thickness, color, transparency)
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = thickness
    stroke.Color = color or ApexUI.Colors.Primary
    stroke.Transparency = transparency or 0
    return stroke
end

local function applyGradient(parent, startColor, endColor, direction)
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, startColor),
        ColorSequenceKeypoint.new(1, endColor)
    })
    if direction == "Vertical" then
        gradient.Rotation = 90
    end
    gradient.Parent = parent
    return gradient
end

-- [[ منطق الفتح والإغلاق المعقد ]] --
local Window = nil

local function toggleWindow(visible)
    local targetPosition = visible and UDim2.fromScale(0.5, 0.5) or UDim2.fromScale(0.5, 1.5)
    local targetAlpha = visible and 0 or 1
    
    local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quint, Enum.EasingDirection.Out)
    
    -- انيميشن الحركة
    local positionTween = TweenService:Create(Window, tweenInfo, {
        Position = targetPosition,
    })
    
    -- انيميشن التعتيم (مفتاح الوميض)
    local alphaTween = TweenService:Create(Window, TweenInfo.new(0.3), {
        BackgroundTransparency = targetAlpha
    })

    if visible then
        Window.Visible = true
        alphaTween:Play()
        positionTween:Play()
    else
        positionTween:Play()
        positionTween.Completed:Wait() -- انتظر حتى يخرج تمامًا
        Window.Visible = false
    end
end

---
--- إنشاء الإطار الرئيسي الفاخر
--- @param settings table
--- @return Frame الإطار الرئيسي
function ApexUI:newWindow(settings)
    settings = settings or {}
    local Name = settings.Name or "ApexUI Interface"
    local Keybind = settings.Keybind or Enum.KeyCode.RightControl
    
    local PlayerGui = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    local MainGui = Instance.new("ScreenGui", PlayerGui)
    MainGui.Name = "ApexUIMainGui"
    MainGui.ResetOnSpawn = false
    
    -- الخلفية المزدوجة (لإعطاء تأثير الظل الناعم)
    Window = Instance.new("Frame")
    Window.Name = "MainWindow"
    Window.Size = UDim2.new(0, 500, 0, 600)
    Window.Position = UDim2.fromScale(0.5, 1.5) -- يبدأ خارج الشاشة (أسفل)
    Window.AnchorPoint = Vector2.new(0.5, 0.5)
    Window.BackgroundColor3 = ApexUI.Colors.BackgroundShadow
    Window.BorderSizePixel = 0
    Window.Visible = false
    
    createCorner(15).Parent = Window
    
    -- الإطار الداخلي الأساسي
    local InnerFrame = Instance.new("Frame")
    InnerFrame.Size = UDim2.new(1, -2, 1, -2) -- أصغر قليلاً من الأب
    InnerFrame.Position = UDim2.new(0, 1, 0, 1)
    InnerFrame.BackgroundColor3 = ApexUI.Colors.Secondary
    InnerFrame.BorderSizePixel = 0
    InnerFrame.Parent = Window
    
    createCorner(14).Parent = InnerFrame
    
    -- شريط العنوان (بتصميم تدرج لوني عمودي)
    local TitleBar = Instance.new("Frame", InnerFrame)
    TitleBar.Size = UDim2.new(1, 0, 0, 45)
    TitleBar.BackgroundColor3 = ApexUI.Colors.Primary
    TitleBar.BorderSizePixel = 0
    
    applyGradient(TitleBar, ApexUI.Colors.Primary, Color3.fromRGB(0, 150, 120), "Vertical")
    
    local TitleLabel = Instance.new("TextLabel", TitleBar)
    TitleLabel.Text = Name
    TitleLabel.Font = Enum.Font.GothamBlack
    TitleLabel.TextSize = 22
    TitleLabel.TextColor3 = ApexUI.Colors.Text
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Size = UDim2.new(1, -20, 1, 0)
    TitleLabel.Position = UDim2.new(0, 10, 0, 0)
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    createStroke(2, Color3.fromRGB(0, 255, 200), 0.7).Parent = TitleLabel -- تأثير "توهج النص"
    
    -- ربط زر الفتح/الإغلاق
    UserInputService.InputBegan:Connect(function(input, gameProcessedEvent)
        if input.KeyCode == Keybind and not gameProcessedEvent then
            toggleWindow(not Window.Visible)
        end
    end)
    
    return InnerFrame -- نعيد الإطار الداخلي لسهولة إضافة المكونات إليه
end

---
--- عرض انترو انيميشن قوي وسلس
--- @param duration number مدة الانيميشن
function ApexUI:showIntro(duration)
    local PlayerGui = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    local IntroGui = Instance.new("ScreenGui", PlayerGui)
    IntroGui.DisplayOrder = 100 
    
    local IntroFrame = Instance.new("Frame", IntroGui)
    IntroFrame.Size = UDim2.new(1, 0, 1, 0)
    IntroFrame.BackgroundColor3 = ApexUI.Colors.Secondary
    
    local LogoLabel = Instance.new("TextLabel", IntroFrame)
    LogoLabel.Text = "A P E X"
    LogoLabel.Font = Enum.Font.GothamBlack
    LogoLabel.TextSize = 50
    LogoLabel.TextColor3 = ApexUI.Colors.Primary
    LogoLabel.BackgroundTransparency = 1
    LogoLabel.Position = UDim2.fromScale(0.5, 0.5)
    LogoLabel.AnchorPoint = Vector2.new(0.5, 0.5)
    LogoLabel.TextTransparency = 1 
    
    -- تأثير "الضبابية" في البداية
    local blurEffect = Instance.new("BlurEffect", game.Lighting)
    blurEffect.Size = 0
    
    -- انيميشن التوهج (Blur In/Out)
    local blurIn = TweenService:Create(blurEffect, TweenInfo.new(duration/2), {Size = 10})
    local blurOut = TweenService:Create(blurEffect, TweenInfo.new(duration/2), {Size = 0})

    blurIn:Play()
    blurIn.Completed:Wait()
    
    -- نص الواجهة يظهر ببطء
    local fadeIn = TweenService:Create(LogoLabel, TweenInfo.new(duration/3), {TextTransparency = 0})
    fadeIn:Play()
    fadeIn.Completed:Wait()

    task.wait(0.5)
    
    -- اختفاء النص والواجهة بالكامل مع تلاشي الضبابية
    local fadeOut = TweenService:Create(IntroFrame, TweenInfo.new(duration/2, Enum.EasingStyle.Quart), {BackgroundTransparency = 1})
    fadeOut:Play()
    blurOut:Play()

    fadeOut.Completed:Wait()
    
    IntroGui:Destroy()
    blurEffect:Destroy()
end

-- [[ إنشاء المكونات المتقدمة ]] --

local function getContentFrame(window)
    -- ... (نفس دالة إنشاء إطار المحتوى من السكربت السابق، لكن بمساحة أكبر)
    local ContentFrame = window:FindFirstChild("Content") or (function()
        local frame = Instance.new("ScrollingFrame") -- استخدام ScrollingFrame أفضل
        frame.Name = "Content"
        frame.Size = UDim2.new(1, -20, 1, -65)
        frame.Position = UDim2.new(0.5, 0, 0, 55)
        frame.AnchorPoint = Vector2.new(0.5, 0)
        frame.BackgroundTransparency = 1
        frame.BorderSizePixel = 0
        frame.CanvasSize = UDim2.new(0, 0, 0, 0) -- يجب تحديثها لاحقاً
        
        local ListLayout = Instance.new("UIListLayout")
        ListLayout.Padding = UDim.new(0, 12)
        ListLayout.Parent = frame
        
        frame.Parent = window
        return frame
    end)()
    return ContentFrame
end

---
--- إضافة زر تبديل بتصميم Neo-Brutalist
function ApexUI:AddToggle(window, name, default, callback)
    local ContentFrame = getContentFrame(window)
    local CurrentState = default or false

    local ToggleFrame = Instance.new("Frame", ContentFrame)
    ToggleFrame.Size = UDim2.new(1, 0, 0, 35)
    ToggleFrame.BackgroundColor3 = ApexUI.Colors.BackgroundShadow
    createCorner(8).Parent = ToggleFrame
    createStroke(1, ApexUI.Colors.Secondary, 0).Parent = ToggleFrame -- خط داكن داخلي

    local Label = Instance.new("TextLabel", ToggleFrame)
    Label.Text = name
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Size = UDim2.new(0.8, -10, 1, 0)
    Label.Position = UDim2.new(0, 10, 0, 0)
    Label.Font = Enum.Font.SourceSansBold
    Label.TextSize = 18
    Label.TextColor3 = ApexUI.Colors.Text
    Label.BackgroundTransparency = 1
    
    local Button = Instance.new("TextButton", ToggleFrame)
    Button.Text = ""
    Button.Size = UDim2.new(0, 50, 0, 25)
    Button.Position = UDim2.new(1, -10, 0.5, 0)
    Button.AnchorPoint = Vector2.new(1, 0.5)
    Button.BorderSizePixel = 0
    createCorner(6).Parent = Button

    -- مؤشر التوهج (الجزء الأكثر جاذبية)
    local GlowStroke = createStroke(3, ApexUI.Colors.Primary, 0)
    GlowStroke.Parent = Button

    local function updateVisuals()
        local color = CurrentState and ApexUI.Colors.Accent or ApexUI.Colors.Element
        local primaryStroke = CurrentState and ApexUI.Colors.Primary or ApexUI.Colors.BackgroundShadow
        
        Button.BackgroundColor3 = color
        GlowStroke.Color = primaryStroke
        GlowStroke.Transparency = CurrentState and 0 or 1
    end
    updateVisuals() -- تعيين الحالة الأولية
    
    -- ربط حدث الضغط
    Button.MouseButton1Click:Connect(function()
        CurrentState = not CurrentState
        updateVisuals()
        -- انيميشن بسيط عند الضغط
        local scaleTween = TweenService:Create(Button, TweenInfo.new(0.1, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 52, 0, 27)
        })
        scaleTween:Play()
        scaleTween.Completed:Wait()
        Button.Size = UDim2.new(0, 50, 0, 25)

        if callback then
            callback(CurrentState)
        end
    end)
    
    return {Element = ToggleFrame, GetState = function() return CurrentState end}
end

-- يمكن تكرار الدوال المماثلة لـ AddSlider و AddDropdown بنفس الأسلوب الفخم
-- ... (AddSlider, AddDropdown يتم بناءهما بنفس المنهجية البصرية)

return ApexUI
